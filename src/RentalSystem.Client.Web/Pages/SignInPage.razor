@page "/signIn"
@using System.Text.RegularExpressions
@layout EmptyLayout


<PageTitle>Sign in</PageTitle>

<div style="width: 100%; height: 100vh; display: flex; padding: 0px">
    <RadzenColumn Style="width: 60%; background-color: rgba(45, 62, 80, 1); display: flex; font-size: 30px; padding: 0px">
        <RadzenText Text="RentAThing" class="app-name" Style=" margin: auto; width: 200px; text-align: center;" />
    </RadzenColumn>

    <RadzenColumn Style="width: 40%; display: flex; background-color: rgba(241,242,246,1); padding: 0px">
        <RadzenColumn Style="text-align: center; display: grid; width: 250px; margin: auto">

            @if (signInVisibility)
            {
                <RadzenText Text="Sign in" class="rz-title" Style="margin: auto; width: 200px; text-align: left; margin-bottom: 20px" />
            }

            @if (!signInVisibility)
            {
                <RadzenText Text="Change password" class="rz-title" Style="margin: auto; width: 200px; text-align: left; margin-bottom: 20px" />
            }

            @if (successVisibility)
            {
                <RadzenText Text="@successMessage" class="rz-text"
                            Style=" font-weight: normal !important; margin: auto; width: 200px; text-align: center; color: #00b600 !important; background-color: #bcffbb; border: 2px solid #00b600; margin-bottom: 10px" />
            }

            @if (errorVisibility)
            {
                <RadzenText Text="@errorMessage" class="rz-text"
                            Style=" font-weight: normal !important; margin: auto; width: 200px; text-align: center; color: red !important; background-color: rgba(255, 211, 211, 1); border: 2px solid #ff0000; margin-bottom: 10px" />
            }

            <RadzenText Text="EMAIL" class="rz-text" Style="margin: auto; width: 200px; text-align: left" />
            <RadzenTextBox Style="margin: auto; margin-top: 5px; margin-bottom: 10px; width: 200px" @bind-Value="email" />


            @if (signInVisibility)
            {
                <RadzenText Text="PASSWORD" class="rz-text" Style="margin: auto; width: 200px; text-align: left" />
                <RadzenPassword Style="margin: auto; margin-top: 5px; margin-bottom: 10px; width: 200px" @bind-Value="password" />

                <RadzenButton Text="SIGN IN" Click="@SignIn" class="rz-button" Style="width: 150px; display: flex; margin: auto; height: 30px; margin-top: 10px; text-align: center" />
            }

            @if (!signInVisibility)
            {
                <RadzenButton Text="CHANGE PASSWORD" Click="@ChangePassword" class="rz-button" Style="width: 200px; display: flex; margin: auto; margin-top: 10px; text-align: center" />
            }

            <RadzenText class="rz-text" Style="margin-top: 15px; font-size: 13px; margin-bottom: 0px; font-weight: normal !important;">
                Don't have an account yet?
                <a href="/signUp" style="color: rgba(45, 62, 80, 1) !important">Sign up!</a>
            </RadzenText>

            @if (!signInVisibility)
            {
                <RadzenText class="rz-text" Style="font-size: 13px; margin-bottom: 0px; font-weight: normal !important;">
                    Already have an account?
                    <a @onclick="ShowSignIn" style="color: rgba(45, 62, 80, 1) !important; cursor: pointer; text-decoration: underline; cursor: pointer">Log in!</a>
                </RadzenText>
            }

            @if (signInVisibility)
            {
                <RadzenText class="rz-text" Style="font-size: 13px; margin-bottom: 0px; font-weight: normal !important;">
                    Forgot your password?
                    <a @onclick="ShowChangePassword" style="color: rgba(45, 62, 80, 1) !important; cursor: pointer; text-decoration: underline; cursor: pointer">Click here</a>
                </RadzenText>
            }
        </RadzenColumn>
    </RadzenColumn>

</div>


@code {
    public class FirebaseAuthResponse
    {
        public bool Success { get; set; }
        public string Token { get; set; }
        public string Error { get; set; }

        public FirebaseAuthResponse(bool success, string token, string error)
        {
            Token = token;
            Success = success;
            Error = error;
        }
    }

    private string errorMessage = "";
    private bool errorVisibility = false;
    private string successMessage = "";
    private bool successVisibility = false;

    private string email = "";
    private string password = "";
    private bool signInVisibility = true;


    async Task SignIn()
    {
        errorMessage = "";
        errorVisibility = false;

        await Task.Yield();

        if (email == "" || password == "")
        {
            ShowError("Fill all the fields");
            return;
        }

        if (!Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$", RegexOptions.IgnoreCase))
        {
            ShowError("Invalid email");
            return;
        }

        var result = await JS.InvokeAsync<FirebaseAuthResponse>("firebaseAuth.login", email, password);

        if (result.Success)
        {
            await JS.InvokeVoidAsync("sessionStorage.setItem", "authToken", result.Token);
            Console.WriteLine("Token obtained and stored: " + result.Token);

            var storageToken = await JS.InvokeAsync<string>("sessionStorage.getItem", "authToken");
            Console.WriteLine("Storage token " + storageToken);

            ((TestAuthenticationStateProvider)AuthProvider).NotifyAuthenticationStateChanged();

            NavManager.NavigateTo("/items");
        }
        else
        {
            Console.WriteLine("Login Error: " + result.Error);
            ShowError(ParseLoginError(result.Error));
        }

        StateHasChanged();
    }

    private void ShowError(string msg)
    {
        errorMessage = msg;
        errorVisibility = true;
        StateHasChanged();
    }

    private string ParseLoginError(string errorCode)
    {
        if (errorCode.Contains("user-not-found") ||
            errorCode.Contains("wrong-password") ||
            errorCode.Contains("invalid-credential") ||
            errorCode.Contains("invalid-email") ||
            errorCode.Contains("INVALID_LOGIN_CREDENTIALS"))
        {
            return "Wrong email or password";
        }

        if (errorCode.Contains("user-disabled"))
            return "This account was banned";

        if (errorCode.Contains("too-many-requests"))
            return "Too many tries, try later";

        return "Sign in failed: " + (errorCode.Length > 50 ? errorCode.Substring(0, 50) : errorCode);
    }


    async Task ShowChangePassword()
    {
        signInVisibility = false;
        errorVisibility = false;
    }

    async Task ShowSignIn()
    {
        signInVisibility = true;
        errorVisibility = false;
    }

    async Task ChangePassword()
    {
        if (email == "")
        {
            ShowError("Fill all the fields");
            return;
        }

        if (!Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$", RegexOptions.IgnoreCase))
        {
            ShowError("Invalid email");
            return;
        }

        var result = await JS.InvokeAsync<FirebaseAuthResponse>("firebaseAuth.passwordReset", email);
        if (result.Success)
        {
            successMessage = "Password changed successfully";
            successVisibility = true;
        }
        else
        {
            ShowError(ParseFirebaseError(result.Error));
        }
    }

    private string ParseFirebaseError(string errorCode)
    {
        if (string.IsNullOrEmpty(errorCode))
            return "An unknown error occurred.";

        var code = errorCode.ToLower();

        if (code.Contains("email-already-in-use"))
            return "This email address is already registered.";

        if (code.Contains("weak-password"))
            return "The password is too weak. It must be at least 6 characters.";

        if (code.Contains("invalid-email"))
            return "The email address is not valid.";

        if (code.Contains("user-not-found") || code.Contains("wrong-password") || code.Contains("invalid-credential"))
            return "Invalid email or password.";

        if (code.Contains("user-disabled"))
            return "This account has been disabled.";

        if (code.Contains("too-many-requests"))
            return "Too many failed attempts. Please try again later.";

        if (code.Contains("network-request-failed"))
            return "Network error. Please check your internet connection.";

        if (code.Contains("requires-recent-login"))
            return "Please log in again before changing your password.";

        if (code.Contains("popup-closed-by-user"))
            return "The login window was closed before finishing.";

        if (code.Contains("conflict"))
            return "A user with this email already exists in our system.";

        return $"Error: {errorCode}";
    }
}